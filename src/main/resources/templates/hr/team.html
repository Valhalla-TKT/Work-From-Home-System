<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" id="fullscreen-body">

<head th:replace="fragments/header :: header">
<title>WorkHub</title>
</head>
<body id="page"
	class="logged-out not-pro not-player not-self not-team not-on-team no-hiring  nav-v2-theme-cream">


	<!-- header -->
	<div th:replace="fragments/navigation :: navigation"></div>
	<!-- header -->

	<div id="g_id_onload"
		data-client_id="32073492121-s6ur8ti01mh34gq2bpbufb8ujdfrpn4v.apps.googleusercontent.com"
		data-login_uri="index.html" data-ux_mode="redirect"></div>

	<div th:replace="fragments/hr/team :: content"></div>
	<!-- main -->
	
<div th:replace="fragments/footer :: footer"></div>


</body>
<div id="site-notifications"></div>

<div th:replace="fragments/chat :: chat"></div>

<script src="/assets/welcome/fullscreen.js"></script>


	
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>

	    $(document).ready(function () {
	    	getAllTeam();
        $('#create-team').click(function(event) {
            event.preventDefault();
            createTeam();
        });
        $('#team-code').prop('disabled', true);
        getAllDepartment();
        $('#department-name').change(function () {
            var selectedOption = $('#department-name option:selected');
            var selectedDepartmentCode = selectedOption.data('code') + "-";
            $('#team-code').prop('disabled', false);
            $('#team-code').val(selectedDepartmentCode);

            $('#team-code').on('input', function (e) {
                var inputValue = this.value;

                if (inputValue.length > 16) {
                    this.value = inputValue.slice(0, 16);
                }
                if (inputValue.length <= 11) {
                    this.value = selectedDepartmentCode; // Reset to the original value
                }
            });

            // Disable backspace key
            $('#team-code').on('keydown', function (e) {
                if (e.which === 8 && this.value.length <= 8) {
                    e.preventDefault();
                }
            });
        });
    });
	    
	    	$('#edit-department-name').change(function () {
	        var selectedOption = $('#edit-department-name option:selected');
	        var departmentId = selectedOption.val();

	        // AJAX request to fetch division data
	        $.ajax({
	            url: '/api/department/getDepartmentById',
	            type: 'POST',
	            contentType: 'application/json',
	            data: JSON.stringify({ divisionId: divisionId }),
	            success: function (response) {
	                var selectedDepartmentCode = response.code + "-";
	                $('#edit-team-code').prop('disabled', false);
	                $('#edit-team-code').val(selectedDepartmentCode);

	                // Disable backspace key
	                $('#edit-team-code').off('keydown').on('keydown', function (e) {
	                    if (e.which === 8 && this.value.length <= 8) {
	                        e.preventDefault();
	                    }
	                });

	                $('#edit-team-code').off('input').on('input', function (e) {
	                    var inputValue = this.value;

	                    if (inputValue.length > 11) {
	                        this.value = inputValue.slice(0, 11);
	                    }

	                    // Reset to the original value if the length is less than or equal to 3
	                    if (inputValue.length <= 8) {
	                        this.value = selectedDepartmentCode;
	                    }
	                });
	            },
	            error: function (error) {
	                console.error('Error:', error);
	            }
	        });
	    });

	    $('#saveChangesBtn').click(function () {
	        var teamId = $(this).data('teamId');
	        saveChanges();
	    });

    function getAllDepartment() {
        $.ajax({
            url: `api/department/departmentList`,
            type: 'POST',
            contentType: 'application/json',
            success: function (response) {
                var selectBox = $('#department-name');
                selectBox.empty();
                selectBox.append('<option value="" disabled selected>Select Department Name</option>');
                for (var i = 0; i < response.length; i++) {
                    var option = $('<option>', {
                        value: response[i].id,
                        text: response[i].name,
                        'data-code': response[i].code
                    });
                    selectBox.append(option);
                }
                var selectBox = $('#department-filter');
                selectBox.empty();
                selectBox.append('<option value="" disabled selected>Select Department Name</option>');
                for (var i = 0; i < response.length; i++) {
                    var option = $('<option>', {
                        value: response[i].id,
                        text: response[i].name,
                        'data-code': response[i].code
                    });
                    selectBox.append(option);
                }
            },
            error: function (error) {
                console.error('Error:', error);
            }
        });
    }

    function createTeam() {
        var code = $('#team-code').val();
        var name = $('#team-name').val();
        var department = $('#department-name').val();
        var requestData = {
            code: code,
            name: name,
            departmentId:department
        };

        $.ajax({
            url: `api/team/create`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                $('#message').text(response);
                $('#add-data-overlay').hide();
                Swal.fire({
          		  title: "Success!",
          		  text: "You've Completely added a new division!",
          		  icon: "success"
          		});
                getAllTeam();
                $('#team-name').val('');
                $('#team-code').val('');
                $('#department-name').val('');
            },
            error: function(error) {
                console.error('Error:', error);
            }
        });
    }

    function getAllTeam() {
    	var rowCount = 0;
        $.ajax({
        	url: `api/team/teamList`,
            type: 'POST',
            contentType: 'application/json',
            success: function (response) {
  				console.log(response)
                $('#team-list').empty();

                response.forEach(function (team) {
              	  rowCount++;
                    $('#team-list').append(`
                   		<li class="job-list-item">
  	                      <a class="job-link" rel="nofollow"
  	                          href="#"></a>
  	                      <div class="job-details-container">
  	                          <div class="lazy-avatar company-avatar">
  	                              <img src="/assets/icons/DAT Logo.png" />
  	                          </div>
  	                          <div class="job-title-company-container">
  	                              <div class="job-role">
  	                                  <span class="job-board-job-company">${team.code}</span>
  	                              </div>
  	                              <h4 class="job-title job-board-job-title">
  	                              	${team.name}
  	                              </h4>
  	                              <div class="job-details job-details--mobile">
  	                                  <div class="color-deep-blue-sea-light-40">
  	                                  
  	                                  </div>
  	                              </div>
  	                          </div>
  	                      </div>
  	                      <div class="job-additional-details-container">
  	                          <div class="buttons-container">
  	                              <button class="form-btn outlined edit-data" data-team-id="${team.id}">Edit </button>
  	                              <button class="btn2 btn2--tertiary margin-l-12 delete-button" data-team-id="${team.id}" onclick="confirmDelete(${team.id}, '${team.name}')">Delete</button>
  	                          </div>
  	                          <div class="job-details">
  	                              <div class="hide-on-desktop data-detail">
  	                                  <a class="manage-data" href="#" data-target="data-modal-1">
  	                                      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
  	                                          <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/>
  	                                      </svg>
  	                                  </a>
  	                                  /* <div id="data-modal-1" class="data-modal">
  	                                      <button class="data-modal-button edit-data edit-button"  data-team-id="${team.id}">Edit</button>
  	                                      <button class="data-modal-button delete-button"  data-team-id="${team.id}">Delete</button>
  	                                  </div> */
  	                              </div>
  	                          </div>
  	                      </div>
  	                  </li>
                    `);
                });
                console.log("row count =", rowCount)
                document.getElementById('total-count').innerText = rowCount
            },
            error: function (error) {
                console.error('Error:', error);
            }
        });
    }
    
    function openEditModal(teamId) {
        $.ajax({
            url: `api/team/getTeam?teamId=${teamId}`,
            type: 'POST',
            contentType: 'application/json',
            success: function (response) {
                $('#edit-team-name').val(response.name);
                $('#edit-team-code').val(response.code);
                $('#teamId').val(teamId);
                
                $.ajax({
                    url: `api/department/departmentList`,
                    type: 'POST',
                    contentType: 'application/json',
                    success: function (departments) {
                        var selectBox = $('#edit-department-name');
                        // Populate select box with all divisions
                        departments.forEach(function(department) {
                            var option = $('<option>', {
                                value: department.id,
                                text: department.name,
                                selected: department.id === response.departmentId // Automatically select the related division
                            });
                            selectBox.append(option);
                        });
                    },
                    error: function (error) {
                        console.error('Error fetching department list:', error);
                    }
                });

                $('#edit-data-overlay').show();
            },
            error: function (error) {
                console.error('Error fetching team data:', error);
            }
        });
    }
      function saveChanges() {
          var editedCode = $('#edit-team-code').val();
          var editedName = $("#edit-team-name").val();
          var teamId = $('#teamId').val();
          var editedDepartmentId = $('#edit-department-name').val();
          var requestData = {
              code: editedCode,
              name: editedName,
              departmentId: editedDepartmentId
          };

          $.ajax({
              url: `api/team/editTeam?teamId=${teamId}`,
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(requestData),
              success: function (response) {
                  console.log('Team data updated successfully:', response);
                  $('#edit-data-overlay').hide();
                  getAllTeam();
              },
              error: function (error) {
                  console.error('Error updating team data:', error);
              }
          });
      }
      function confirmDelete(teamId, teamName) {
          Swal.fire({
              title: `Are you sure you want to delete ${teamName}?`,
              text: "This action cannot be undone!",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, delete it!'
          }).then((result) => {
              if (result.isConfirmed) {
              	deleteTeam(teamId)
              	Swal.fire(
                      'Deleted!',
                      `Team with ID ${teamId} has been deleted.`,
                      'success'
                  );
              }
          });
      }  
      function deleteTeam(teamId) {
        $.ajax({
            url: `/api/team/deleteById?id=${teamId}`,
            type: 'POST',
            success: function(response) {
                console.log('Team deleted successfully:', response);
                $(`#team-list li[data-team-id="${teamId}"]`).remove();
                getAllTeam();
            },
            error: function(error) {
                console.error('Error deleting team:', error);
            }
        });
    	}
    	  $(document).on('click', '.delete-button', function() {
    		    var teamId = $(this).data('teamId');
    		    var teamName = $(this).closest('.job-list-item').find('.job-board-job-title').text().trim();
    		    deleteTeam(teamId, teamName);
    			});
    	
    	  $(document).on('click', '.edit-data', function() {
    		    var teamId = $(this).data('team-id');
    		    openEditModal(teamId);
    		});
    	  

    </script>


    <script type="text/javascript">
      // Get the modal
      var modal = document.getElementById("myModal");

      // Get the button that opens the modal
      var btn = document.getElementById("create-team");

      // When the user clicks on the button, open the modal
      btn.onclick = function() {
        modal.style.display = "block";
      }

      // When the user clicks anywhere outside of the modal, close it
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
      
      document.addEventListener('DOMContentLoaded', function () {
    	    document.querySelector('.add-data').addEventListener('click', function () {
    	        document.getElementById('add-data-overlay').style.display = 'block';
    	        document.getElementById('add-data-modal').style.display = 'block';
    	    });
    	    document.querySelector('#add-data-overlay .close').addEventListener('click', function () {
    	        document.getElementById('add-data-overlay').style.display = 'none';
    	        document.getElementById('add-data-modal').style.display = 'none';
    	    });

    	    document.querySelector('.edit-data').addEventListener('click', function() {
    	        document.getElementById('edit-data-overlay').style.display = 'block';
    	        document.getElementById('edit-data-modal').style.display = 'block';
    	    });
    		
    	    document.querySelector('#edit-data-overlay .close').addEventListener('click', function() {	    	
    	        document.getElementById('edit-data-overlay').style.display = 'none';
    	        document.getElementById('edit-data-modal').style.display = 'none';
    	    });
    	    
    	    document.querySelectorAll('.manage-data').forEach(item => {
    	        item.addEventListener('click', event => {
    	            const targetId = event.currentTarget.getAttribute('data-target');
    	            const modal = document.getElementById(targetId);
    	            if (modal) {
    	                modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
    	            }
    	        });
    	    });

    	    
    	});
</script>





</body>

</html>
